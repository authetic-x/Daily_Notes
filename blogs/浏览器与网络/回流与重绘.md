## 前言

回流和重绘这两个名词应该算是面试的常客了，知道它们的概念本身并不难，更重要的是要知道哪些操作会导致回流和重绘从而影响页面的性能，并且能提出相应的优化手段。



## 什么是回流和重绘？

回流和重绘是浏览器渲染页面的流程之一。浏览器的渲染大概要经过以下几个阶段：

1. 解析 HTML 文件，生成与标签对应的 dom 树
2. 解析 HTML 文件中所引用的 CSS，包括 `link` 标签里的、`style` 标签里的、以及元素上的内联样式，生成 `document.styleSheets` 对象
3. 有了 CSS 之后就可以知道页面长什么样子了，生成渲染树(render tree)
4. 绘制 render tree，页面会分为许多个图层，将每个图层切为多个图块，生成绘制指令发送给渲染进程进行处理，最终显示在页面上

### 重绘

当元素的一些样式属性发生改变，如字体颜色，背景色等，需要重新绘制图层。

### 回流

当页面中元素的几何属性发生变化，就需要重新构建布局树，然后切分图层进行绘制。可见回流一定会触发重绘，所以回流的性能损耗更大。发生回流的场景：

1. 添加或者删除可见的DOM元素；
2. 元素位置改变；
3. 元素尺寸改变——边距、填充、边框、宽度和高度
4. 内容改变——比如文本改变或者图片大小改变而引起的计算值宽度和高度改变；
5. 页面渲染初始化；
6. 浏览器窗口尺寸改变——resize事件发生时；

### 浏览器优化机制

由于每次重排都会造成额外的计算消耗，因此大多数浏览器都会通过队列化修改并批量执行来优化重排过程。浏览器会将修改操作放入到队列里，直到过了一段时间或者操作达到了一个阈值，才清空队列。但是，**当你获取布局信息的操作的时候，会强制队列刷新**，比如调用以下属性或方法时：

* offsetTop、offsetLeft、offsetWidth、offsetHeight
* getComputedStyle()
* getBoundingClientRect()



## 优化策略

### 1. 批量更新 dom

### 2. 缓存元素样式属性

### 3. 将复杂的动画效果放到绝对定位或固定定位的元素上

### 4. 动画尽量使用 transform, opacity 属性

对于 transform 和 opacity 效果，不会触发 layout 和 paint



## 参考

* [前端基本功（四）：性能优化之你真的懂回流、重绘与合成层吗？](http://kmanong.top/kmn/qxw/form/article?id=369&cate=51)

* [你真的了解回流和重绘吗](https://segmentfault.com/a/1190000017329980)

* [浏览器渲染流程&Composite（渲染层合并）简单总结](https://segmentfault.com/a/1190000014520786)

  