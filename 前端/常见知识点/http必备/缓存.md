![http缓存](F:%5Cdesktop%5CDaily_Notes%5Cpublic%5Chttp%E7%BC%93%E5%AD%98.jpg)

http 缓存分为两种：强缓存和协商缓存。缓存的目的是为了提高资源加载的速度，减少网络传输从而缓解服务器的压力。



## 强缓存

强缓存不需要重新发请求到服务端，直接读取浏览器本地缓存。存放的位置可以是硬盘或内存，具体有浏览器控制。强缓存主要由三个字段控制：`Expires, Cache-Control, Pragma`

### Expires

值是一个http日期，如果系统时间超过了 Expires 的值，则缓存失效。由于时差问题，当系统时间和服务器时间不一致时会出现问题。其优先级在三个属性中最低

### Cache-Control

HTTP/1.1 新增的属性，请求头和响应头中都可以使用，介绍几个常用值：

* `max-age`，单位是秒，缓存时间计算的方式是距离发起的时间的秒数，超过间隔的秒数缓存失效，`max-age=00` 表示禁用强缓存
* `no-cache`，不使用强缓存
* `no-store`，禁用缓存(包括协商缓存)，每次都向服务器获取最新资源

### Pragma

只有一个值：`no-cache`，效果和 `Cache-Control: no-cache` 一致，表示不使用强缓存，不过它的优先级最高



## 协商缓存

当强缓存失效或是头部字段设置不走强缓存，且请求头设置了 `If-Modified-Since` 或者 `If-None-Match` 时，会去服务器验证是否命中协商缓存，如果命中会返回304状态码，并在响应头中会设置相应的 `Last-Modified` 和 `ETag` 属性

### ETag/If-None-Macth

这两个属性的值是一串 hash 码，当服务器文件内容发生变化时，hash 也会相应的改变。通过请求头的 `If-None-Match` 值和文件 hash 值做比较可判断是否命中协商缓存。ETag 又有强弱校验之分，如果 hash 码是以 "W/" 开头的一串字符串，说明此时协商缓存的校验是弱校验的，只有服务器上的文件差异（根据 ETag 计算方式来决定）达到能够触发 hash 值后缀变化的时候，才会真正地请求资源，否则返回 304 并加载浏览器缓存。

### Last-Modified/If-Modified-Since

属性值代表文件最后修改时间，第一次请求服务器会把文件最后修改时间放在 `Last-Modified` 响应头中，第二次发起请求会带上上一次请求的最后修改时间，放在 `If-Modified-Since` 属性中，根据时间是否相等判断是否命中协商缓存



### ETag/If-None-Match 的优点

* 如果文件修改在秒级以下，`Last-Modified/If-Modified-Since` 会错误的返回304
* 如果文件被修改了，但内容实际上没有变化，`Last-Modified/If-Modified-Since` 会错误的返回304

